<p>[code lang="c"]<br />
    public interface IContinueTask<br />
    {<br />
        string TaskName { get; }<br />
        TimeSpan Interval { get; }<br />
        IObservable&lt;TimeSpan&gt; ObservableIntervalChange { get; }<br />
        void Action();<br />
    }</p>
<p>    public class ContinuousTaskItem<br />
    {<br />
        private CancellationTokenSource m_cancelTokenSource = new CancellationTokenSource();<br />
        private IContinueTask m_task;</p>
<p>        public ContinuousTaskItem(IContinueTask task)<br />
        {<br />
            m_task = task;<br />
        }</p>
<p>        public bool Cancel()<br />
        {<br />
            m_cancelTokenSource.Cancel();<br />
            return true;<br />
        }</p>
<p>        public Task Create()<br />
        {<br />
            return Task.Factory.StartNew(<br />
                () =&gt;<br />
                {<br />
                    while (true)<br />
                    {<br />
                        if (m_cancelTokenSource.Token.WaitHandle.WaitOne(m_task.Interval))<br />
                            break;</p>
<p>                        m_task.Action();<br />
                    }<br />
                }, m_cancelTokenSource.Token, TaskCreationOptions.LongRunning, TaskScheduler.Default);<br />
        }<br />
    }</p>
<p>    public class ContinuousTaskManager<br />
    {<br />
        private Dictionary&lt;string, ContinuousTaskItem&gt; m_taskList = new Dictionary&lt;string, ContinuousTaskItem&gt;();</p>
<p>        public ContinuousTaskManager()<br />
        {</p>
<p>        }</p>
<p>        public bool AddContinueTask(IContinueTask task)<br />
        {<br />
            lock (m_taskList)<br />
            {<br />
                if (m_taskList.Keys.FirstOrDefault(x =&gt; x == task.TaskName) == null)<br />
                {<br />
                    var ob = task.ObservableIntervalChange.Subscribe(<br />
                            interval =&gt;<br />
                            {<br />
                                lock (m_taskList)<br />
                                {<br />
                                    // delete task<br />
                                    ContinuousTaskItem taskItem = null;<br />
                                    if (m_taskList.TryGetValue(task.TaskName, out taskItem))<br />
                                    {<br />
                                        taskItem.Cancel();<br />
                                        m_taskList.Remove(task.TaskName);</p>
<p>                                        // create again<br />
                                        var newTask = new ContinuousTaskItem(task);<br />
                                        m_taskList.Add(task.TaskName, newTask);<br />
                                        newTask.Create();<br />
                                    }<br />
                                }<br />
                            }<br />
                        );<br />
                    var item = new ContinuousTaskItem(task);<br />
                    m_taskList.Add(task.TaskName, item);<br />
                    item.Create();</p>
<p>                    return true;<br />
                }<br />
                return false;<br />
            }<br />
        }</p>
<p>        public bool RemoveTask(string taskName)<br />
        {<br />
            lock (m_taskList)<br />
            {<br />
                // delete task<br />
                ContinuousTaskItem taskItem = null;<br />
                if (m_taskList.TryGetValue(taskName, out taskItem))<br />
                {<br />
                    taskItem.Cancel();<br />
                    m_taskList.Remove(taskName);<br />
                    return true;<br />
                }<br />
            }<br />
            return false;<br />
        }</p>
<p>        public void Clear()<br />
        {<br />
            lock (m_taskList)<br />
            {<br />
                foreach (var task in m_taskList.Values)<br />
                {<br />
                    task.Cancel();<br />
                }</p>
<p>                m_taskList.Clear();<br />
            }<br />
        }<br />
    }<br />
[/code]</p>
