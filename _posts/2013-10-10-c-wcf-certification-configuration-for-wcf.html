---
layout: post
title: C# WCF - certification configuration for WCF
date: 2013-10-10 08:50:39.000000000 -05:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- ".NET"
- Programming
tags: []
meta:
  _edit_last: '14827209'
  _publicize_pending: '1'
author:
  login: acrocontext
  email: nsclass@hotmail.com
  display_name: acrocontext
  first_name: ''
  last_name: ''
permalink: "/2013/10/10/c-wcf-certification-configuration-for-wcf/"
---
<p>Server side configuration<br />
[code lang="c"]<br />
static Binding CreateBinding()<br />
{<br />
    int maxReceivedSize = Constants.MAX_PACKET_LENGTH;</p>
<p>    NetTcpBinding clientManBinding = new NetTcpBinding(SecurityMode.Message, false);</p>
<p>    clientManBinding.TransferMode = TransferMode.Buffered;<br />
    clientManBinding.MaxBufferSize = maxReceivedSize;<br />
    clientManBinding.MaxReceivedMessageSize = maxReceivedSize;<br />
    clientManBinding.ReaderQuotas.MaxStringContentLength = maxReceivedSize;<br />
    clientManBinding.ReaderQuotas.MaxBytesPerRead = maxReceivedSize;<br />
    clientManBinding.ReaderQuotas.MaxArrayLength = maxReceivedSize;<br />
    clientManBinding.ReaderQuotas.MaxDepth = 1024;<br />
    clientManBinding.MaxBufferPoolSize = maxReceivedSize;</p>
<p>    clientManBinding.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;</p>
<p>    TimeSpan ClockSkew = TimeSpan.MaxValue;<br />
    CustomBinding custBinding = new CustomBinding(clientManBinding);<br />
    SymmetricSecurityBindingElement security = custBinding.Elements.Find&lt;SymmetricSecurityBindingElement&gt;();<br />
    security.LocalClientSettings.MaxClockSkew = ClockSkew;<br />
    security.LocalServiceSettings.MaxClockSkew = ClockSkew;<br />
    security.LocalServiceSettings.DetectReplays = false;<br />
    security.LocalClientSettings.DetectReplays = false;</p>
<p>    SecureConversationSecurityTokenParameters secureTokenParams = (SecureConversationSecurityTokenParameters)security.ProtectionTokenParameters;<br />
    // From the collection, get the bootstrap element.<br />
    SecurityBindingElement bootstrap = secureTokenParams.BootstrapSecurityBindingElement;<br />
    // Set the MaxClockSkew on the bootstrap element.<br />
    bootstrap.LocalClientSettings.MaxClockSkew = ClockSkew;<br />
    bootstrap.LocalServiceSettings.MaxClockSkew = ClockSkew;<br />
    bootstrap.LocalServiceSettings.DetectReplays = false;<br />
    bootstrap.LocalClientSettings.DetectReplays = false;</p>
<p>    return custBinding;<br />
}</p>
<p>public WcfServiceHost(Uri address, Binding binding, X509Certificate2 serverCert, X509Certificate2 clientCert)<br />
{<br />
    m_serviceHost = new ServiceHost(typeof(Host), address);<br />
    m_serviceHost.Credentials.ServiceCertificate.Certificate = serverCert;<br />
    m_serviceHost.Credentials.ClientCertificate.Authentication.CertificateValidationMode = System.ServiceModel.Security.X509CertificateValidationMode.None;<br />
    m_serviceHost.Credentials.ClientCertificate.Authentication.RevocationMode = X509RevocationMode.NoCheck;<br />
    m_serviceHost.Credentials.ClientCertificate.Certificate = clientCert;<br />
}</p>
<p>[/code]</p>
<p>Client side configuration<br />
[code lang="c"]<br />
// create TCP binding<br />
protected static NetTcpBinding CreateDefaultSecureNetTCPBinding()<br />
{<br />
    SecurityMode security = SecurityMode.Message;<br />
    int maxStringContentLength = Constants.MAX_PACKET_LENGTH;</p>
<p>    NetTcpBinding tcpIpBinding = new NetTcpBinding();<br />
    tcpIpBinding.Security.Mode = security;<br />
    if (security == SecurityMode.Message)<br />
    {<br />
        tcpIpBinding.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;<br />
    }<br />
    tcpIpBinding.ReaderQuotas.MaxArrayLength = maxStringContentLength;<br />
    tcpIpBinding.ReaderQuotas.MaxBytesPerRead = maxStringContentLength;<br />
    tcpIpBinding.ReaderQuotas.MaxStringContentLength = maxStringContentLength;<br />
    tcpIpBinding.ReaderQuotas.MaxDepth = 100;<br />
    tcpIpBinding.MaxReceivedMessageSize = maxStringContentLength;<br />
    tcpIpBinding.MaxBufferSize = maxStringContentLength;</p>
<p>    return tcpIpBinding;<br />
}</p>
<p>// create endpoint address with created TCP binding and certification<br />
public static EndpointAddress GetSecureEndPointAddress(Uri uri, X509Certificate2 cert)<br />
{<br />
    EndpointAddress endpointAddress = new EndpointAddress(uri, EndpointIdentity.CreateX509CertificateIdentity(cert));<br />
    return endpointAddress;<br />
}</p>
<p>// create proxy(ClientBase&lt;I&gt;) based on created binding and certificated address<br />
protected virtual Proxy CreateProxy(Binding binding, EndpointAddress addr, X509Certificate2 cert)<br />
{<br />
    var proxy = new Proxy(binding, addr);<br />
    proxy.ClientCredentials.ClientCertificate.Certificate = cert;<br />
    proxy.ClientCredentials.ServiceCertificate.Authentication.CertificateValidationMode = System.ServiceModel.Security.X509CertificateValidationMode.None;<br />
    return proxy;<br />
}</p>
<p>// open proxy<br />
protected void Open(Binding binding, EndpointAddress endpointAddr, X509Certificate2 cert)<br />
{<br />
    m_proxy = CreateProxy(BootstrapBinding(binding), endpointAddr, cert);<br />
    m_proxy.Open();<br />
}<br />
[/code]</p>
