---
layout: post
title: C# - Simple example implementing concurrent queue
date: 2015-02-27 07:49:29.000000000 -06:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- ".NET"
- Programming
tags:
- C++
meta:
  _edit_last: '14827209'
  _publicize_pending: '1'
  geo_public: '0'
author:
  login: acrocontext
  email: nsclass@hotmail.com
  display_name: acrocontext
  first_name: ''
  last_name: ''
permalink: "/2015/02/27/c-simple-example-implementing-concurrent-queue/"
---
<p>[code lang="c"]<br />
public class ActionQueueItem<br />
{<br />
    public ActionQueueItem(Action operation, string name, int priority)<br />
    {<br />
        Operation = operation;<br />
        Delay = 500; // 500 milliseconds<br />
        Name = name;<br />
        Priority = priority;<br />
    }</p>
<p>    public ActionQueueItem(Action operation, string name, int delay, int priority)<br />
    {<br />
        Operation = operation;<br />
        Name = name;<br />
        Delay = delay;<br />
        Priority = priority;<br />
    }</p>
<p>    public Action Operation { get; private set; }<br />
    public int Delay { get; set; }<br />
    public string Name { get; set; }<br />
    public int Priority { get; set; }<br />
}</p>
<p>public class ActionDelayQueue<br />
{<br />
    ManualResetEvent m_stopEvent = new ManualResetEvent(false);<br />
    ManualResetEvent m_enqueuEvent = new ManualResetEvent(false);<br />
    Thread m_processTask;</p>
<p>    List&lt;ActionQueueItem&gt; m_queue = new List&lt;ActionQueueItem&gt;();</p>
<p>    public ActionDelayQueue()<br />
    {</p>
<p>    }</p>
<p>    public bool Start()<br />
    {<br />
        Stop();</p>
<p>        m_stopEvent.Reset();<br />
        m_processTask = new Thread(Process);<br />
        m_processTask.Start();<br />
        return true;<br />
    }</p>
<p>    public bool Stop()<br />
    {<br />
        if (m_processTask != null)<br />
        {<br />
            m_stopEvent.Set();<br />
            if (!m_stopEvent.WaitOne(1000))<br />
                m_processTask.Abort();</p>
<p>            m_processTask = null;<br />
            return true;<br />
        }</p>
<p>        return false;<br />
    }</p>
<p>    public void Enqueue(ActionQueueItem item)<br />
    {<br />
        lock (m_queue)<br />
        {<br />
            if (item.Priority &gt;= 5)<br />
            {<br />
                m_queue.Insert(0, item);<br />
            }<br />
            else<br />
                m_queue.Add(item);</p>
<p>            m_enqueuEvent.Set();<br />
        }<br />
    }</p>
<p>    private void Process()<br />
    {<br />
        try<br />
        {<br />
            WaitHandle[] list = new WaitHandle[] { m_stopEvent, m_enqueuEvent };<br />
            while (true)<br />
            {<br />
                var res = WaitHandle.WaitAny(list);<br />
                if (0 == res)<br />
                    break;<br />
                else if (1 == res)<br />
                {<br />
                    ActionQueueItem action = null;<br />
                    lock (m_queue)<br />
                    {<br />
                        if (m_queue.Count &gt; 0)<br />
                        {<br />
                            var currentTime = DateTime.Now;<br />
                            action = m_queue[0];<br />
                            m_queue.RemoveAt(0);</p>
<p>                            if (m_queue.Count &lt;= 0)<br />
                                m_enqueuEvent.Reset();<br />
                        }<br />
                    }</p>
<p>                    if (action != null)<br />
                    {<br />
                        Thread.Sleep(action.Delay);<br />
                        action.Operation();<br />
                    }<br />
                }<br />
            }<br />
        }<br />
        catch (Exception e)<br />
        {<br />
            Trace.WriteLine(e.Message);<br />
        }<br />
    }<br />
}<br />
[/code]</p>
